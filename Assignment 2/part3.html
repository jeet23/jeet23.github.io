<!DOCTYPE html>
<html lang = "en" class="tas-com">
<head>
	<meta charset="utf-8">
	<title>D3: Interactions In D3</title>
	<link href="./themes/prism.css" rel="stylesheet" />
	<link href="./themes/tas_style.css" rel="stylesheet" />
	<script type="text/javascript" src="./d3/d3.v4.js" charset="utf-8"></script>
	<script src="./lib/prism.js" charset="utf-8"></script>
	<style type="text/css">
		.axis path,
		.axis line {
		    fill: none;
		    stroke: black;
		    shape-rendering: crispEdges;
		}
		
		.axis text {
		    font-family: sans-serif;
		    font-size: 11px;
		}	
		.button-bar {
			width: 500px;
			margin-bottom: 20px;
    	}
		.button {
			float: left;
			margin-left: 15px;
			cursor: pointer;
		}
		.play_button {
			float: left;
			margin-left: 15px;
			cursor: pointer;
		}
     	.selected {
			font-weight: bold;
		}
	</style>
</head>
<body>

	<h1>HANS ROSLING</h1>
	<h2>Part 2</h2>
	
	<div class = "demo">

		<!-- <div class = "button-bar">
			<div class = "play_button">Play All</div>
		</div>
		<hr style="clear:both;"> -->
		<!-- <div class = "button-bar">
			<div class = "button selected">2013</div> <div class = "button">2014</div> <div class = "button">2015</div>
		</div> -->
		<hr style="clear:both;">
		<div>
		<script type="text/javascript" id = "demo_code">
// Define margins
var margin = {top: 10, right: 10, bottom: 25, left: 35};

//Width and height
var outer_width = 800;
var outer_height = 300;
var svg_width = outer_width - margin.left - margin.right;
var svg_height = outer_height - margin.top - margin.bottom;


// define a function that filters data by year
function yearFilter(value){
	return (value.Year == display_year)
}

//Create SVG element as a group with the margins transform applied to it
var svg = d3.select("body")
			.append("svg")
			.attr("width", svg_width + margin.left + margin.right)
			.attr("height", svg_height + margin.top + margin.bottom)
			.append("g")
			.attr("transform", "translate(" + margin.left + "," + margin.top + ")");


var yearToDisplayBehind = svg.append("text")
							.attr("x",600)
							.attr("y",10)
							.attr("dy", ".35em")
							.style("fill","black")
							.style("font-size",25)
							.style("opacity",1)

var yScale = d3.scaleLinear()
	                     .range([svg_height, 0]);

var xScale = d3.scaleBand()
				.range([0, svg_width])
				.paddingInner(0.05)
				.paddingOuter(0.05);
			

var yAxis = d3.axisLeft()
				  .scale(yScale)
				  .ticks(5);

var xAxis = d3.axisBottom()
			 .scale(xScale);

			  
svg.append("g")
	.attr("class", "axis")
	.attr("id", "y-axis");
		
svg.append("g")
	.attr("class", "axis")
	.attr("id", "x-axis")
	.attr("transform", "translate(0," + svg_height + ")");


function generateVis(display_year){
		
	// Filter the data to only include the current year
	var filtered_datset = dataset.filter(function yearFilter(value){
					return (value.Year == display_year)});

	var nested_data2 = d3.nest()
						.key(function(d) { return d.Government; })
						.key(function(d) { return d.Country; })
						.rollup(function(d) { return d.Country; })
						.entries(filtered_datset);

		
 	/******** PERFORM DATA JOIN ************/
  	// Join new data with old elements, if any.
  	var bars = 	svg.selectAll("rect")
	   .data(nested_data2, function key(d) {
								return d.Country;
							});

 	/******** HANDLE UPDATE SELECTION ************/
  	// Update the display of existing elelemnts to match new data
  	bars
  		.attr("x", function(d) {
	   		return xScale(d.key);
	   })
	   .attr("y", function(d) {
	   		return yScale(d.values.length) ;
	   })
	   .attr("width", xScale.bandwidth())
	   .attr("height", function(d) {
	   		return svg_height - yScale(d.values.length);
	   });

		   
	/******** HANDLE ENTER SELECTION ************/
  	// Create new elements in the dataset
  	bars.enter()
		.append("rect")
		.attr("x", function(d, i) {
	   		return xScale(d.key);
	   })
	   .attr("y", function(d) {
	   		return yScale(d.values.length) ;
	   })
	   .attr("width", xScale.bandwidth())
	   .attr("height", function(d) {
	   		return svg_height - yScale(d.values.length);
	   })
	   .style("fill", "blue")


	 yearToDisplayBehind.text("Year: " +display_year);

	/******** HANDLE EXIT SELECTION ************/
	// Remove bars that not longer have a matching data eleement
	bars.exit().remove();
  		
	// Set the year label
	d3.select("#year_header").text("Year: " + display_year)

}

// Load the file data.csv and generate a visualisation based on it
d3.csv("./data/Gapminder_All_Time.csv", function(error, data){
	
	var years = d3.map(data, function(d) { return d.Year}).keys().sort()
	display_year = years[0]


	// handle any data loading errors
	if(error){
		console.log("Something went wrong");
		console.log(error);
	}else{
		console.log("Data Loaded");
		
		// Assign  the data object loaded to the global dataset variable
		dataset = data;

		var nested_data2 = d3.nest()
					.key(function(d) { return d.Government; })
					.key(function(d) { return d.Country; })
					.rollup(function(d) { return d.Country; })
					.entries(dataset);

		xScale.domain(dataset.map(function(d) { return d.Government ; }));

		max_count = d3.max(nested_data2, function(d) { return d.values.length;})
		min_count = d3.min(nested_data2, function(d) { return d.values.length;})
		yScale.domain([min_count, max_count]);
		svg.select("#x-axis").call(xAxis);
		svg.select("#y-axis").call(yAxis);
		
		// Generate the visualisation
		generateVis(display_year);

		var index = 1;
		var myInterval = setInterval(function() {
			display_year = years[index]
			if(index == years.length - 1){
				index = 1;
				// clearInterval(myInterval);
			}
			index += 1
		  	generateVis(display_year);
		}, 500);
	}
});

		</script>
		</div>
	</div>
	

</body>	 
</html>